resources:
  - name: resource-subscription
    template: |
      apiVersion: pubsub.cnrm.cloud.google.com/v1beta1
      kind: PubSubSubscription
      metadata:
        name: "{{root.spec.pubSubPrefix}}-subscription"
      spec:
        ackDeadlineSeconds: 15
        messageRetentionDuration: 86400s
        retainAckedMessages: false
        topicRef:
          name: "{{root.spec.pubSubPrefix}}-topic"
        deadLetterPolicy:
          deadLetterTopicRef:
            name: "{{root.spec.pubSubPrefix}}-deadletter-topic"
    dependsOn:
      - resource-topic
      - resource-deadletter-topic
  - name: resource-topic
    template: |
      apiVersion: pubsub.cnrm.cloud.google.com/v1beta1
      kind: PubSubTopic
      metadata:
        name: "{{root.spec.pubSubPrefix}}-topic"
  - name: resource-deadletter-topic
    template: |
      apiVersion: pubsub.cnrm.cloud.google.com/v1beta1
      kind: PubSubTopic
      metadata:
        name: "{{root.spec.pubSubPrefix}}-deadletter-topic"
    conditions: "if root.spec.pubSubPrefix.startsWith('dl')"
  - name: resource-configmap
    template: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: "{{root.spec.pubSubPrefix}}-configmap"
      data:
        subscriptionTTL: "{{resource-subscription.spec.expirationPolicy.ttl}}"
    dependsOn:
      - resource-subscription